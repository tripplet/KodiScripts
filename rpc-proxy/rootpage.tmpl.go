package main

import (
	"net/http"
	"strconv"
	"strings"
	"text/template"
)

func rootpage(w http.ResponseWriter, req *http.Request) {
	// The "/" pattern matches everything, so we need to check
	// that we're at the root here.
	if req.URL.Path != "/" {
		http.NotFound(w, req)
		return
	}

	// get rid of :port
	host := req.Host
	if i := strings.Index(host, ":"); i != -1 {
		host = host[:i]
	}

	templ.Execute(w, struct {
		KodiURL string
		KodiRPC string
	}{
		KodiURL: "http://" + host + ":" + strconv.Itoa(*kodiHttpPort),
		KodiRPC: host + ":" + strconv.Itoa(*kodiRpcPort),
	})
}

var templ = template.Must(template.New("").Delims("%%%", "%%%").Parse(content))

// %%%%content=rootpage.htm%%%%
// START OF AUTOGENERATED CONTENT - DO NOT CHANGE ANYTHING BELOW
// GENERATED: 2021-02-18 21:34:13.774374 +0100 CET m=+0.002066558
var content = `<!doctype html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Kodi</title><style>*{box-sizing:border-box}:root{--background:rgb(210, 210, 210);--slider-text-color:rgb(0, 71, 95)}@media screen and (prefers-color-scheme:dark){:root{--color:rgb(219, 219, 219);--background:#25282c;--background-popup:var(--background);--slider-text-color:rgb(102, 181, 208)}input{color:var(--color)}input.InputAddOn-field{background-color:var(--background);filter:brightness(1.6)}}html,body{height:100%;background-color:var(--background);margin:0}@media(max-width:750px){.InputAddOn{display:block!important;text-align:center;margin:0 auto}.InputAddOn-field,.InputAddOn-item{padding:1em!important}input[name=url]{width:85%!important}}a{color:#008cba}.container{height:100%;font-family:helvetica neue,Helvetica,Arial,sans-serif;display:-webkit-flex;display:-ms-flexbox;display:flex;flex-direction:column;align-items:center;-webkit-align-items:center;justify-content:center;-webkit-justify-content:center}.InputAddOn{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:1.5em}#sec-link{text-align:center;margin:0 auto}.InputAddOn-field{-webkit-box-flex:1;-webkit-flex:1;-ms-flex:1;flex:1}.InputAddOn-field:not(:first-child){border-left:0}.InputAddOn-field:not(:last-child){border-right:0}.InputAddOn-item{background-color:#008cba;color:#fff;box-shadow:rgba(0,0,0,.2)0 -2px inset;-webkit-box-shadow:rgba(0,0,0,.2)0 -2px 0 0 inset;font-weight:400;cursor:pointer;font-weight:700;margin-left:-1px}.InputAddOn-item:disabled{background-color:#969696;cursor:default}.InputAddOn-field,.InputAddOn-item{border:1px solid rgba(147,128,108,.25);padding:1em 2em;font-size:12pt;-webkit-appearance:none}input.InputAddOn-field:focus,input.InputAddOn-item:focus{outline:none}.InputAddOn-field:first-child,.InputAddOn-item:first-child{border-radius:2px 0 0 2px}.InputAddOn-field:last-child,.InputAddOn-item:last-child{border-radius:0 2px 2px 0}.sk-wave{margin:10px auto 30px;width:50px;height:40px;text-align:center;font-size:10px;display:none}.sk-wave .sk-rect{background-color:#008cba;height:100%;width:6px;display:inline-block;margin:.5px;-webkit-animation:sk-waveStretchDelay 1.2s infinite ease-in-out;animation:sk-waveStretchDelay 1.2s infinite ease-in-out}.sk-wave .sk-rect1{-webkit-animation-delay:-1.2s;animation-delay:-1.2s}.sk-wave .sk-rect2{-webkit-animation-delay:-1.1s;animation-delay:-1.1s}.sk-wave .sk-rect3{-webkit-animation-delay:-1s;animation-delay:-1s}.sk-wave .sk-rect4{-webkit-animation-delay:-.9s;animation-delay:-.9s}.sk-wave .sk-rect5{-webkit-animation-delay:-.8s;animation-delay:-.8s}@-webkit-keyframes sk-waveStretchDelay{0%,40%,100%{-webkit-transform:scaleY(.4);transform:scaleY(.4)}20%{-webkit-transform:scaleY(1);transform:scaleY(1)}}@keyframes sk-waveStretchDelay{0%,40%,100%{-webkit-transform:scaleY(.4);transform:scaleY(.4)}20%{-webkit-transform:scaleY(1);transform:scaleY(1)}}.slidecontainer{width:100%;display:none}.slider{-webkit-appearance:none;width:calc(100% - 20px);margin-left:10px;height:10px;border-radius:3px;background:#fff;outline:none;opacity:.7}.slider-text{text-align:center;margin:10px;color:var(--slider-text-color)}.slider:hover{opacity:1}.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:#008cba;cursor:pointer}.slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#008cba;cursor:pointer}</style><script>window.active_playerid=-1,window.refresh_timer=null;const ws=new WebSocket(localStorage.getItem('OVERRIDE_WS_URL')||'ws://%%% .KodiRPC %%%');function resetForm(a){const b=document.getElementById('link'),c=document.getElementById('progress'),d=document.getElementById('send-link');a?progress_state='block':progress_state='none',c.style.display=progress_state,d.disabled=a,b.disabled=a}function sendUrl(){resetForm(!0),fetch('/jsonrpc',{headers:{'Content-Type':'application/json'},method:'post',body:JSON.stringify({url:link.value})}).then(function(a){resetForm(!1),link.value=''}).catch(function(a){resetForm(!1),alert(a)})}function getPercentage(){window.active_playerid!=-1&&ws.send(JSON.stringify({id:1,jsonrpc:'2.0',method:'Player.GetProperties',params:{playerid:window.active_playerid,properties:['percentage','time','totaltime']}})),clearTimeout(window.refresh_timer),window.active_playerid!=-1&&(window.refresh_timer=window.setTimeout(getPercentage,1e3))}function getActivePlayers(){ws.send(JSON.stringify({id:1,jsonrpc:'2.0',method:'Player.GetActivePlayers'}))}function hideProgress(){window.active_playerid=-1,document.getElementById('slider-container-main').style.display='none'}function getTitle(){if(window.active_playerid==-1)return;ws.send(JSON.stringify({id:1,jsonrpc:'2.0',method:'Player.GetItem',params:{playerid:window.active_playerid}}))}function seek(a){if(window.active_playerid==-1)return;ws.send(JSON.stringify({id:1,jsonrpc:'2.0',method:'Player.Seek',params:{playerid:window.active_playerid,value:parseFloat(a)}}))}ws.onopen=function(){getActivePlayers()},ws.onerror=function(a){console.log('Error: '+a.data)},ws.onmessage=function(b){const a=JSON.parse(b.data);if(a===void 0)return;if('result'in a){{const b=a.result;if(b.length==1&&b[0]===Object(b[0])&&'playerid'in b[0])window.active_playerid=b[0].playerid,getPercentage(),getTitle();else if(b===Object(b)&&'item'in b)document.getElementById('info-text').innerHTML=b.item.label;else if(b===Object(b)&&'percentage'in b){if(b.percentage==0)return;document.getElementById('progress-slider').value=b.percentage,document.getElementById('progress-text').innerHTML=b.time.hours+'h'+b.time.minutes+'m'+b.time.seconds+'s',document.getElementById('slider-container-main').style.display='block'}}}else a===Object(a)&&'method'in a&&(a.method=='Player.OnPlay'?(window.active_playerid=a.params.data.player.playerid,getTitle(),getPercentage()):a.method=='Player.OnPause'?window.active_playerid=-1:a.method=='Player.OnResume'?getPercentage():a.method=='Player.OnStop'&&hideProgress())}</script><div class=container><form><div class=InputAddOn><input name=url id=link class=InputAddOn-field placeholder=http://... autocomplete=off type=url size=50 autofocus required>
<input class=InputAddOn-item id=send-link type=submit onclick=sendUrl()></div><div class=sk-wave id=progress><div class="sk-rect sk-rect1"></div><div class="sk-rect sk-rect2"></div><div class="sk-rect sk-rect3"></div><div class="sk-rect sk-rect4"></div><div class="sk-rect sk-rect5"></div></div><div id=slider-container-main class=slidecontainer><div class=slider-text id=info-text></div><input type=range min=1 max=100 class=slider id=progress-slider onchange=seek(this.value)><div class=slider-text id=progress-text></div></div><div style=text-align:center><a href="%%% .KodiURL %%%">Kodi Web Interface</a></div></form></div>`